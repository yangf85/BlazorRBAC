# Day 01 - 环境准备与数据库设计

> ⏱️ 预计时间：2小时

## 🎯 今日目标

- [ ] 理解 RBAC 核心概念
- [ ] 确认 PostgreSQL 已安装并能正常连接
- [ ] 创建 `blazor_rbac` 数据库
- [ ] 理解系统的表结构设计思路

---

## 📚 核心概念

### 什么是 RBAC？

**RBAC（Role-Based Access Control）** = 基于角色的访问控制

```
用户 → 拥有 → 角色 → 拥有 → 权限（菜单）
```

**示例**：
- 张三（用户）→ 管理员（角色）→ 可以访问"用户管理"页面（权限）
- 李四（用户）→ 普通用户（角色）→ 只能访问"个人中心"页面（权限）

### 我们的简化模型

- **菜单 = 权限**：一个菜单项就是一个权限点
- **3级菜单**：模块 → 功能组 → 页面
- **页面级权限**：不做按钮级控制

---

## 💻 环境准备

### 1. 确认 PostgreSQL 已安装

**检查方式**：
- 打开数据库管理工具（Navicat、pgAdmin、DBeaver 等）
- 尝试连接到 PostgreSQL
- 默认配置：
  - Host: `localhost`
  - Port: `5432`
  - Username: `postgres`
  - Password: 你安装时设置的密码

**如果还没安装**：

**方式一：官方安装包**
1. 下载：https://www.postgresql.org/download/
2. 安装时记住密码
3. 默认端口：`5432`

**方式二：Docker（推荐）**
```bash
docker run --name postgres-rbac \
  -e POSTGRES_PASSWORD=postgres123 \
  -p 5432:5432 \
  -d postgres:15
```

### 2. 创建数据库

**使用 Navicat 创建**：
1. 右键连接 → 新建数据库
2. 数据库名称：`blazor_rbac`
3. 字符集：`UTF8`
4. 其他保持默认
5. 点击"确定"

**或使用 SQL 创建**：
```sql
CREATE DATABASE "blazor_rbac"
WITH
  OWNER = "postgres"
  ENCODING = 'UTF8'
;
```

✅ 创建成功后，在 Navicat 左侧应该能看到 `blazor_rbac` 数据库。

---

## 📊 数据库设计（概念理解）

> ⚠️ **注意**：本节只介绍表的作用和关系，不涉及详细字段设计。
> 
> 详细的实体类设计和字段定义在 Day 3 会详细讲解，那时会使用 FreeSql 的 CodeFirst 模式自动创建表。

### 核心6张表

1. **sys_user** - 用户表
   - 存储用户基本信息（用户名、密码、邮箱等）
   - 支持本地登录和第三方登录（微信）
   - 记录最后登录时间和IP

2. **sys_role** - 角色表
   - 定义系统角色（超级管理员、管理员、普通用户等）
   - 支持启用/禁用角色
   - 标识系统角色（is_system）

3. **sys_menu** - 菜单/权限表
   - **菜单即权限**的核心表
   - 支持3级菜单结构
   - 记录路由路径和图标

4. **sys_user_role** - 用户角色关联表
   - 实现用户和角色的**多对多**关系
   - 一个用户可以有多个角色
   - 一个角色可以分配给多个用户

5. **sys_role_menu** - 角色菜单关联表
   - 实现角色和菜单的**多对多**关系
   - 一个角色可以访问多个菜单
   - 一个菜单可以被多个角色访问

6. **sys_login_log** - 登录日志表
   - 记录每次登录行为（成功/失败）
   - 记录登录IP、浏览器、操作系统等信息
   - 用于安全审计

### 表关系图

```
        sys_user (用户)
           ↓
    sys_user_role (用户角色关联)
           ↓
        sys_role (角色)
           ↓
    sys_role_menu (角色菜单关联)
           ↓
        sys_menu (菜单/权限)

        sys_user (用户)
           ↓
     sys_login_log (登录日志)
```

### 设计亮点

#### 1. 基类继承设计
系统采用**基类继承**方式，所有实体类继承自统一的基类：

- **BaseEntity**：提供主键 `Id`
- **AuditEntity**：在 BaseEntity 基础上添加审计字段（创建时间、更新时间）

**优势**：
- 代码复用，避免重复定义字段
- 统一审计，自动记录创建和更新时间
- 易于扩展，后续可以统一添加创建人、更新人等字段

#### 2. 自动时间戳
使用 FreeSql 的 `ServerTime` 特性：
- `created_at`：插入时自动设置
- `updated_at`：更新时自动修改
- 无需手动维护时间字段

#### 3. 第三方登录支持
用户表预留字段支持微信等第三方登录：
- `login_type`：登录类型（Local、WeChat）
- `external_id`：第三方平台用户ID

#### 4. 超级管理员机制
角色表通过 `is_system` 字段标识系统角色：
- 系统角色不可删除
- 系统角色拥有所有权限（跳过权限检查）

---

## 🔗 准备连接字符串

记下数据库连接信息，明天（Day 2）配置项目时会用到：

```json
{
  "ConnectionStrings": {
    "Default": "Host=localhost;Port=5432;Database=blazor_rbac;Username=postgres;Password=你的密码"
  }
}
```

**连接字符串格式说明**：
- `Host`：数据库服务器地址（本地就是 localhost）
- `Port`：端口号（PostgreSQL 默认 5432）
- `Database`：数据库名称（blazor_rbac）
- `Username`：用户名（通常是 postgres）
- `Password`：你的数据库密码

---

## 🧪 验证步骤

### 使用 Navicat 验证

1. **连接到 PostgreSQL**：
   - 打开 Navicat
   - 双击你的 PostgreSQL 连接
   - 确保能成功连接

2. **检查数据库**：
   - 在左侧数据库列表中找到 `blazor_rbac`
   - 双击展开，应该能看到：
     - 📁 模式 (Schemas)
       - 📁 public
         - 📁 表 (Tables) ← 目前是空的

3. **测试连接字符串**（可选）：
   ```bash
   # 使用 psql 命令行工具测试
   psql -h localhost -p 5432 -U postgres -d blazor_rbac
   ```

---

## 📝 今日总结

### ✅ 完成检查清单

- [ ] 理解了 RBAC 的基本原理（用户 → 角色 → 权限）
- [ ] PostgreSQL 已安装并能正常连接
- [ ] 创建了空的 `blazor_rbac` 数据库
- [ ] 理解了 6 张表的作用和关系
- [ ] 理解了基类继承的设计思路
- [ ] 准备好了数据库连接字符串

### 🎓 知识点回顾

1. **RBAC模型**：用户 → 角色 → 权限（菜单）
2. **菜单即权限**：简化设计，一个菜单就是一个权限点
3. **超级管理员**：通过 `is_system` 字段标识，拥有所有权限
4. **6张表的关系**：
   - 核心3张：用户、角色、菜单
   - 关联2张：用户角色、角色菜单
   - 日志1张：登录日志

### 💡 重要提醒

**表创建方式**：
- ❌ 不需要手动写 SQL 创建表
- ✅ Day 3 会使用 FreeSql 的 CodeFirst 模式
- ✅ 通过 C# 实体类定义表结构
- ✅ FreeSql 会自动同步到数据库

**基类设计**：
- Day 3 会详细讲解 `BaseEntity` 和 `AuditEntity` 的实现
- 理解基类继承的优势（代码复用、统一审计）

### 🐛 常见问题

**Q：PostgreSQL 安装后无法连接？**
- 检查服务是否启动
- 检查端口 5432 是否被占用
- 确认密码是否正确

**Q：创建数据库时报错 "invalid locale"？**
- 使用简单的 SQL：`CREATE DATABASE "blazor_rbac" WITH ENCODING = 'UTF8';`
- 或者不指定 LC_CTYPE，让系统使用默认值

**Q：为什么不手动建表？**
- FreeSql 的 CodeFirst 模式更灵活
- 表结构变更时，代码和数据库同步更方便
- 减少手动 SQL 出错的可能

**Q：为什么现在不讲详细的字段设计？**
- Day 1 重点是理解概念和准备环境
- 详细的实体类设计在 Day 3，那时会配合 FreeSql 特性一起讲解
- 先把数据库环境准备好，明天开始搭建项目

---

## ➡️ 下一步

明天（Day 2）我们将：
- 创建 .NET 10 解决方案（5个项目）
- 安装必要的 NuGet 包
- 配置 FreeSql 连接 PostgreSQL
- 测试从代码访问数据库

**准备工作**：
- ✅ 确保 `blazor_rbac` 数据库创建成功
- ✅ 准备好连接字符串
- ✅ 安装 .NET 10 SDK（如果还没装）

---

[⬅️ 返回目录](./00-总文档.md) | [下一天：项目搭建 ➡️](./02-项目搭建.md)
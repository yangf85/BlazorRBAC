# BlazorRBAC - Blazor Server 权限管理系统

## 📋 项目概述

基于 Blazor Server 的 RBAC（Role-Based Access Control）权限管理系统，实现页面级权限控制和动态菜单生成。

## 🎯 核心功能

- ✅ 用户注册/登录（本地 + 微信第三方登录）
- ✅ 基于角色的权限管理（RBAC）
- ✅ 动态菜单生成（3级菜单）
- ✅ 页面级权限验证
- ✅ 超级管理员支持
- ✅ JWT Token 认证

## 🛠️ 技术栈

| 分类 | 技术 | 说明 |
|------|------|------|
| **框架** | Blazor Server | UI框架 |
| | .NET 9 | 运行时 |
| | C# 12 | 编程语言 |
| **UI组件** | MudBlazor | UI组件库 |
| **数据库** | PostgreSQL | 关系型数据库 |
| **ORM** | FreeSql | 数据访问 |
| **验证** | FluentValidation | 数据验证 |
| **映射** | Mapster | 对象映射 |
| **认证** | JWT Bearer | Token认证 |
| | BCrypt.Net-Next | 密码加密 |
| **文档** | Scalar | API文档 |
| **日志** | Serilog | 日志记录 |
| **HTTP** | WebApiClientCore | HTTP客户端 |

## 📊 数据库设计

### 核心5张表

```
1. sys_user          - 用户表
2. sys_role          - 角色表
3. sys_menu          - 菜单/权限表（菜单即权限）
4. sys_user_role     - 用户角色关联表
5. sys_role_menu     - 角色菜单关联表
```

### 关系图

```
用户 ←→ 用户角色 ←→ 角色 ←→ 角色菜单 ←→ 菜单
```

## 🏗️ 项目架构

### 分层结构

```
BlazorRBAC.sln
├── BlazorRBAC.Domain          # 领域层（实体、枚举）
├── BlazorRBAC.Application     # 应用层（DTO、Service、验证器）
├── BlazorRBAC.Infrastructure  # 基础设施（FreeSql、JWT）
├── BlazorRBAC.Api             # WebAPI（控制器、扩展）
└── BlazorRBAC.Web             # Blazor Server（页面、组件）
```

### 实际项目结构

```
BlazorRBAC/
├── src/
│   ├── BlazorRBAC.Domain/
│   │   └── （实体类）
│   │
│   ├── BlazorRBAC.Application/
│   │   └── （DTO、Service、Validator）
│   │
│   ├── BlazorRBAC.Infrastructure/
│   │   └── Database/
│   │       └── FreeSqlSetup.cs
│   │
│   ├── BlazorRBAC.Api/
│   │   ├── Controllers/
│   │   ├── Extensions/                    ← 扩展方法模式
│   │   │   ├── ServiceCollectionExtensions.cs
│   │   │   ├── ApplicationBuilderExtensions.cs
│   │   │   └── SerilogExtensions.cs
│   │   ├── logs/
│   │   ├── Program.cs                     ← 保持简洁
│   │   └── appsettings.json
│   │
│   └── BlazorRBAC.Web/
│       └── （Blazor 组件）
```

## 🎨 架构设计模式

### 扩展方法模式（核心设计）

**目的**：保持 Program.cs 简洁，职责分离

| 扩展类 | 职责 | 示例方法 |
|--------|------|----------|
| ServiceCollectionExtensions | 服务注册 | AddDatabase()<br>AddApiDocumentation()<br>AddJwtAuthentication() |
| ApplicationBuilderExtensions | 中间件配置 | UseApiDocumentation() |
| SerilogExtensions | 日志配置 | ConfigureSerilog()<br>AddSerilog() |

**效果**：
```csharp
// Program.cs 保持简洁
builder.Services.AddDatabase(builder.Configuration);
builder.Services.AddApiDocumentation();
app.UseApiDocumentation();
```

### 命名规范

- ✅ 避免与 NuGet 包重名：用 `Database` 而非 `FreeSql` 文件夹
- ✅ 扩展方法命名：`Add*` 用于服务注册，`Use*` 用于中间件
- ✅ 统一风格：所有配置都通过扩展方法调用

## 📅 学习计划（10天，每天2小时）

| 天数 | 主题 | 核心内容 |
|-----|------|---------|
| Day 1 | 环境准备 | PostgreSQL 安装配置 |
| Day 2 | 项目搭建 | 多层架构、扩展方法模式、FreeSql/Serilog 配置 |
| Day 3 | 实体与数据 | 5个实体类、种子数据 |
| Day 4 | 认证与JWT | 注册、登录、JWT |
| Day 5 | 权限验证 | 授权策略、动态菜单 |
| Day 6 | Blazor认证 | AuthenticationStateProvider |
| Day 7 | 动态菜单UI | MudBlazor 菜单树 |
| Day 8 | 后台管理 | CRUD 操作 |
| Day 9 | 微信登录 | OAuth 流程 |
| Day 10 | 优化完善 | RefreshToken、安全加固 |

## 🔑 关键设计决策

### 1. 菜单即权限
- 一个菜单 = 一个权限 = 一个路由

### 2. 固定3级菜单
- 一级：模块（系统管理）
- 二级：功能组（用户管理）
- 三级：页面（用户列表）

### 3. 超级管理员
- 角色表 `IsSystem` 字段标识
- 跳过权限检查

### 4. 扩展方法架构
- 所有配置通过扩展方法组织
- Program.cs 保持简洁可读

### 5. 暂不实现
- ❌ 缓存层（Redis）
- ❌ 按钮级权限
- ❌ 数据权限（行级）

## 📚 快速开始

### 环境要求
- .NET 9 SDK
- PostgreSQL 15+
- Visual Studio 2022

### 核心 NuGet 包
```bash
# Infrastructure
FreeSql, FreeSql.Provider.PostgreSQL
BCrypt.Net-Next, System.IdentityModel.Tokens.Jwt
Serilog.AspNetCore

# Application  
FluentValidation, Mapster

# Api
Microsoft.AspNetCore.Authentication.JwtBearer
Scalar.AspNetCore

# Web
MudBlazor, WebApiClientCore
```

### 数据库连接
```json
{
  "ConnectionStrings": {
    "Default": "Host=localhost;Port=5432;Database=blazor_rbac;Username=postgres;Password=postgres"
  }
}
```

## 🔒 安全建议

- BCrypt 密码加密（迭代 ≥ 10）
- AccessToken 短期（15-30分钟）
- RefreshToken 长期（7天）
- 生产环境强制 HTTPS

## 📞 后续扩展

- Redis 缓存
- 按钮级权限
- 操作日志审计
- 单元测试

---

**版本**：v1.1  
**更新**：2024-12-18  
**新增**：扩展方法架构模式、实际项目结构
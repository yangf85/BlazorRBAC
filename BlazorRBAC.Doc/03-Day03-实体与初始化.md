# Day 03 - å®ä½“ç±»ä¸æ•°æ®åˆå§‹åŒ–

> â±ï¸ é¢„è®¡æ—¶é—´ï¼š2å°æ—¶

## ğŸ¯ ä»Šæ—¥ç›®æ ‡

- [ ] å®šä¹‰ 5 ä¸ªå®ä½“ç±»
- [ ] é…ç½® FreeSql å®ä½“æ˜ å°„
- [ ] ç¼–å†™ç§å­æ•°æ®æœåŠ¡
- [ ] è‡ªåŠ¨ç”Ÿæˆè¡¨å¹¶æ’å…¥åˆå§‹æ•°æ®

---

## ğŸ’» å®šä¹‰å®ä½“ç±»

### åŸºç¡€å®ä½“ç±»

**æ–‡ä»¶**ï¼š`src/BlazorRBAC.Domain/Entities/BaseEntity.cs`

```csharp
namespace BlazorRBAC.Domain.Entities;

public abstract class BaseEntity
{
    public long Id { get; set; }
    public DateTime CreatedAt { get; set; } = DateTime.UtcNow;
}
```

### 1. ç”¨æˆ·å®ä½“

**æ–‡ä»¶**ï¼š`src/BlazorRBAC.Domain/Entities/SysUser.cs`

```csharp
using FreeSql.DataAnnotations;

namespace BlazorRBAC.Domain.Entities;

[Table(Name = "sys_user")]
public class SysUser : BaseEntity
{
    [Column(StringLength = 50, IsNullable = false)]
    public string Username { get; set; } = string.Empty;

    [Column(StringLength = 200, IsNullable = false)]
    public string PasswordHash { get; set; } = string.Empty;

    [Column(StringLength = 50)]
    public string? RealName { get; set; }

    [Column(StringLength = 100)]
    public string? Email { get; set; }

    [Column(StringLength = 20)]
    public string? Phone { get; set; }

    [Column(StringLength = 20)]
    public string LoginType { get; set; } = "Local"; // Local, WeChat

    [Column(StringLength = 200)]
    public string? ExternalId { get; set; }

    public bool IsActive { get; set; } = true;

    // å¯¼èˆªå±æ€§
    [Navigate(ManyToMany = typeof(SysUserRole))]
    public List<SysRole> Roles { get; set; } = new();
}
```

### 2. è§’è‰²å®ä½“

**æ–‡ä»¶**ï¼š`src/BlazorRBAC.Domain/Entities/SysRole.cs`

```csharp
using FreeSql.DataAnnotations;

namespace BlazorRBAC.Domain.Entities;

[Table(Name = "sys_role")]
public class SysRole : BaseEntity
{
    [Column(StringLength = 50, IsNullable = false)]
    public string RoleName { get; set; } = string.Empty;

    [Column(StringLength = 50, IsNullable = false)]
    public string RoleCode { get; set; } = string.Empty;

    [Column(StringLength = 200)]
    public string? Description { get; set; }

    public bool IsSystem { get; set; } = false; // è¶…çº§ç®¡ç†å‘˜æ ‡è¯†

    // å¯¼èˆªå±æ€§
    [Navigate(ManyToMany = typeof(SysRoleMenu))]
    public List<SysMenu> Menus { get; set; } = new();
}
```

### 3. èœå•å®ä½“

**æ–‡ä»¶**ï¼š`src/BlazorRBAC.Domain/Entities/SysMenu.cs`

```csharp
using FreeSql.DataAnnotations;

namespace BlazorRBAC.Domain.Entities;

[Table(Name = "sys_menu")]
public class SysMenu : BaseEntity
{
    public long ParentId { get; set; } = 0;

    [Column(StringLength = 50, IsNullable = false)]
    public string MenuName { get; set; } = string.Empty;

    [Column(StringLength = 50, IsNullable = false)]
    public string MenuCode { get; set; } = string.Empty;

    [Column(StringLength = 200)]
    public string? RoutePath { get; set; }

    [Column(StringLength = 50)]
    public string? Icon { get; set; }

    public int SortOrder { get; set; } = 0;
    public int MenuLevel { get; set; } = 1; // 1,2,3
    public bool IsVisible { get; set; } = true;
}
```

### 4-5. å…³è”å®ä½“

**æ–‡ä»¶**ï¼š`src/BlazorRBAC.Domain/Entities/SysUserRole.cs`

```csharp
using FreeSql.DataAnnotations;

namespace BlazorRBAC.Domain.Entities;

[Table(Name = "sys_user_role")]
public class SysUserRole : BaseEntity
{
    public long UserId { get; set; }
    public long RoleId { get; set; }
}
```

**æ–‡ä»¶**ï¼š`src/BlazorRBAC.Domain/Entities/SysRoleMenu.cs`

```csharp
using FreeSql.DataAnnotations;

namespace BlazorRBAC.Domain.Entities;

[Table(Name = "sys_role_menu")]
public class SysRoleMenu : BaseEntity
{
    public long RoleId { get; set; }
    public long MenuId { get; set; }
}
```

---

## ğŸŒ± ç§å­æ•°æ®æœåŠ¡

**æ–‡ä»¶**ï¼š`src/BlazorRBAC.Infrastructure/Data/SeedDataService.cs`

```csharp
using BlazorRBAC.Domain.Entities;
using BCrypt.Net;

namespace BlazorRBAC.Infrastructure.Data;

public class SeedDataService
{
    private readonly IFreeSql _fsql;

    public SeedDataService(IFreeSql fsql)
    {
        _fsql = fsql;
    }

    public async Task InitializeAsync()
    {
        // 1. åŒæ­¥è¡¨ç»“æ„
        _fsql.CodeFirst.SyncStructure<SysUser>();
        _fsql.CodeFirst.SyncStructure<SysRole>();
        _fsql.CodeFirst.SyncStructure<SysMenu>();
        _fsql.CodeFirst.SyncStructure<SysUserRole>();
        _fsql.CodeFirst.SyncStructure<SysRoleMenu>();

        // 2. æ£€æŸ¥æ˜¯å¦å·²æœ‰æ•°æ®
        if (await _fsql.Select<SysUser>().AnyAsync())
        {
            Console.WriteLine("æ•°æ®å·²å­˜åœ¨ï¼Œè·³è¿‡åˆå§‹åŒ–");
            return;
        }

        // 3. æ’å…¥è§’è‰²
        var roles = new List<SysRole>
        {
            new() { RoleName = "è¶…çº§ç®¡ç†å‘˜", RoleCode = "SuperAdmin", IsSystem = true },
            new() { RoleName = "ç®¡ç†å‘˜", RoleCode = "Admin", IsSystem = false },
            new() { RoleName = "æ™®é€šç”¨æˆ·", RoleCode = "User", IsSystem = false }
        };
        await _fsql.Insert(roles).ExecuteAffrowsAsync();

        // 4. æ’å…¥èœå•ï¼ˆ3çº§ç»“æ„ï¼‰
        var menus = new List<SysMenu>
        {
            // ä¸€çº§èœå•
            new() { Id = 1, MenuName = "ç³»ç»Ÿç®¡ç†", MenuCode = "system", Icon = "Settings", MenuLevel = 1, SortOrder = 1 },
            new() { Id = 2, MenuName = "ä¸ªäººä¸­å¿ƒ", MenuCode = "profile", Icon = "Person", MenuLevel = 1, SortOrder = 2 },

            // äºŒçº§èœå•ï¼ˆç³»ç»Ÿç®¡ç†ä¸‹ï¼‰
            new() { Id = 11, ParentId = 1, MenuName = "ç”¨æˆ·ç®¡ç†", MenuCode = "user-mgr", Icon = "People", MenuLevel = 2, RoutePath = "/admin/users", SortOrder = 1 },
            new() { Id = 12, ParentId = 1, MenuName = "è§’è‰²ç®¡ç†", MenuCode = "role-mgr", Icon = "Shield", MenuLevel = 2, RoutePath = "/admin/roles", SortOrder = 2 },

            // äºŒçº§èœå•ï¼ˆä¸ªäººä¸­å¿ƒä¸‹ï¼‰
            new() { Id = 21, ParentId = 2, MenuName = "ä¸ªäººä¿¡æ¯", MenuCode = "profile-info", Icon = "AccountCircle", MenuLevel = 2, RoutePath = "/profile/info", SortOrder = 1 }
        };
        await _fsql.Insert(menus).ExecuteAffrowsAsync();

        // 5. æ’å…¥ç”¨æˆ·ï¼ˆå¯†ç ï¼šadmin123ï¼‰
        var users = new List<SysUser>
        {
            new()
            {
                Username = "admin",
                PasswordHash = BCrypt.Net.BCrypt.HashPassword("admin123"),
                RealName = "ç³»ç»Ÿç®¡ç†å‘˜",
                Email = "admin@example.com"
            }
        };
        await _fsql.Insert(users).ExecuteAffrowsAsync();

        // 6. åˆ†é…è§’è‰²ï¼ˆadmin -> SuperAdminï¼‰
        await _fsql.Insert(new SysUserRole { UserId = 1, RoleId = 1 }).ExecuteAffrowsAsync();

        // 7. åˆ†é…èœå•ï¼ˆSuperAdminæ‹¥æœ‰æ‰€æœ‰èœå•ï¼‰
        var roleMenus = menus.Select(m => new SysRoleMenu { RoleId = 1, MenuId = m.Id });
        await _fsql.Insert(roleMenus).ExecuteAffrowsAsync();

        Console.WriteLine("âœ… ç§å­æ•°æ®åˆå§‹åŒ–å®Œæˆï¼");
    }
}
```

---

## ğŸ”§ æ³¨å†ŒæœåŠ¡

**æ–‡ä»¶**ï¼š`src/BlazorRBAC.Api/Program.cs`

```csharp
using BlazorRBAC.Infrastructure.Data;

var builder = WebApplication.CreateBuilder(args);

// ... å…¶ä»–æœåŠ¡ ...
builder.Services.AddScoped<SeedDataService>();

var app = builder.Build();

// åˆå§‹åŒ–æ•°æ®åº“
using (var scope = app.Services.CreateScope())
{
    var seeder = scope.ServiceProvider.GetRequiredService<SeedDataService>();
    await seeder.InitializeAsync();
}

app.Run();
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### 1. è¿è¡Œé¡¹ç›®

```bash
cd src/BlazorRBAC.Api
dotnet run
```

### 2. æ£€æŸ¥æ§åˆ¶å°è¾“å‡º

åº”è¯¥çœ‹åˆ°ï¼š
```
âœ… ç§å­æ•°æ®åˆå§‹åŒ–å®Œæˆï¼
```

### 3. æŸ¥è¯¢æ•°æ®åº“

```sql
-- æŸ¥çœ‹ç”¨æˆ·
SELECT * FROM sys_user;

-- æŸ¥çœ‹è§’è‰²
SELECT * FROM sys_role;

-- æŸ¥çœ‹èœå•
SELECT * FROM sys_menu ORDER BY parent_id, sort_order;

-- æŸ¥çœ‹ç”¨æˆ·çš„è§’è‰²
SELECT u.username, r.role_name
FROM sys_user u
JOIN sys_user_role ur ON u.id = ur.user_id
JOIN sys_role r ON ur.role_id = r.id;
```

---

## ğŸ“ ä»Šæ—¥æ€»ç»“

### âœ… å®Œæˆæ£€æŸ¥æ¸…å•

- [ ] å®šä¹‰äº† 5 ä¸ªå®ä½“ç±»
- [ ] é…ç½®äº† FreeSql ç‰¹æ€§
- [ ] ç¼–å†™äº†ç§å­æ•°æ®æœåŠ¡
- [ ] æˆåŠŸåˆå§‹åŒ–æ•°æ®åº“è¡¨å’Œæ•°æ®
- [ ] éªŒè¯äº†æ•°æ®æ’å…¥æˆåŠŸ

### ğŸ“ çŸ¥è¯†ç‚¹

1. **FreeSql ç‰¹æ€§**ï¼š`[Table]`ã€`[Column]`ã€`[Navigate]`
2. **BCrypt**ï¼šå®‰å…¨çš„å¯†ç å“ˆå¸Œç®—æ³•
3. **CodeFirst**ï¼šè‡ªåŠ¨æ ¹æ®å®ä½“ç”Ÿæˆè¡¨ç»“æ„

### ğŸ› å¸¸è§é—®é¢˜

**Qï¼šè¡¨å·²å­˜åœ¨ä½†ç»“æ„ä¸å¯¹ï¼Ÿ**
- åˆ é™¤è¡¨åé‡æ–°è¿è¡Œ
- æˆ–æ‰‹åŠ¨è°ƒæ•´ `UseAutoSyncStructure(true)`

---

## â¡ï¸ ä¸‹ä¸€æ­¥

æ˜å¤©ï¼ˆDay 4ï¼‰æˆ‘ä»¬å°†ï¼š
- å®ç°ç”¨æˆ·æ³¨å†Œ API
- å®ç°ç™»å½•å¹¶ç”Ÿæˆ JWT Token

---

[â¬…ï¸ ä¸Šä¸€å¤©](./02-Day02-é¡¹ç›®æ­å»º.md) | [è¿”å›ç›®å½•](./README.md) | [ä¸‹ä¸€å¤© â¡ï¸](./04-Day04-è®¤è¯ä¸JWT.md)

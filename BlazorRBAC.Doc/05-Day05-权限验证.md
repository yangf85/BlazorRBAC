# Day 05 - æƒé™éªŒè¯ä¸åŠ¨æ€èœå•

> â±ï¸ é¢„è®¡æ—¶é—´ï¼š2å°æ—¶

## ğŸ¯ ä»Šæ—¥ç›®æ ‡

- [ ] å®ç°è‡ªå®šä¹‰æˆæƒç­–ç•¥
- [ ] åˆ›å»ºæƒé™éªŒè¯ Attribute
- [ ] å®ç°åŠ¨æ€èœå•æŸ¥è¯¢æœåŠ¡
- [ ] æµ‹è¯•æƒé™éªŒè¯

---

## ğŸ’» æ ¸å¿ƒå®ç°

### 1. èœå•æœåŠ¡

**æ–‡ä»¶**ï¼š`src/BlazorRBAC.Application/Services/MenuService.cs`

```csharp
using BlazorRBAC.Domain.Entities;

namespace BlazorRBAC.Application.Services;

public class MenuService
{
    private readonly IFreeSql _fsql;

    public MenuService(IFreeSql fsql)
    {
        _fsql = fsql;
    }

    // è·å–ç”¨æˆ·èœå•ï¼ˆæ ‘å½¢ç»“æ„ï¼‰
    public async Task<List<MenuDto>> GetUserMenusAsync(long userId)
    {
        // æ£€æŸ¥æ˜¯å¦è¶…çº§ç®¡ç†å‘˜
        var isSuperAdmin = await _fsql.Select<SysUser>()
            .From<SysUserRole, SysRole>((u, ur, r) => u.Id == ur.UserId && ur.RoleId == r.Id)
            .Where((u, ur, r) => u.Id == userId && r.IsSystem)
            .AnyAsync();

        List<SysMenu> menus;

        if (isSuperAdmin)
        {
            // è¶…ç®¡ï¼šæ‰€æœ‰èœå•
            menus = await _fsql.Select<SysMenu>()
                .Where(m => m.IsVisible)
                .OrderBy(m => m.SortOrder)
                .ToListAsync();
        }
        else
        {
            // æ™®é€šç”¨æˆ·ï¼šæ ¹æ®è§’è‰²è·å–èœå•
            menus = await _fsql.Select<SysMenu>()
                .From<SysRoleMenu, SysUserRole>((m, rm, ur) =>
                    m.Id == rm.MenuId && rm.RoleId == ur.RoleId && ur.UserId == userId)
                .Where(m => m.IsVisible)
                .OrderBy(m => m.SortOrder)
                .ToListAsync();
        }

        return BuildMenuTree(menus, 0);
    }

    // æ„å»ºèœå•æ ‘
    private List<MenuDto> BuildMenuTree(List<SysMenu> menus, long parentId)
    {
        return menus
            .Where(m => m.ParentId == parentId)
            .Select(m => new MenuDto
            {
                Id = m.Id,
                MenuName = m.MenuName,
                MenuCode = m.MenuCode,
                RoutePath = m.RoutePath,
                Icon = m.Icon,
                Children = BuildMenuTree(menus, m.Id)
            })
            .ToList();
    }
}

public class MenuDto
{
    public long Id { get; set; }
    public string MenuName { get; set; } = string.Empty;
    public string MenuCode { get; set; } = string.Empty;
    public string? RoutePath { get; set; }
    public string? Icon { get; set; }
    public List<MenuDto> Children { get; set; } = new();
}
```

### 2. èœå•æ§åˆ¶å™¨

**æ–‡ä»¶**ï¼š`src/BlazorRBAC.Api/Controllers/MenuController.cs`

```csharp
using System.Security.Claims;
using BlazorRBAC.Application.Services;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;

namespace BlazorRBAC.Api.Controllers;

[ApiController]
[Route("api/[controller]")]
[Authorize]  // éœ€è¦è®¤è¯
public class MenuController : ControllerBase
{
    private readonly MenuService _menuService;

    public MenuController(MenuService menuService)
    {
        _menuService = menuService;
    }

    [HttpGet("user-menus")]
    public async Task<IActionResult> GetUserMenus()
    {
        var userId = long.Parse(User.FindFirst(ClaimTypes.NameIdentifier)!.Value);
        var menus = await _menuService.GetUserMenusAsync(userId);
        return Ok(menus);
    }
}
```

### 3. æ³¨å†ŒæœåŠ¡

**Program.cs**ï¼š

```csharp
builder.Services.AddScoped<MenuService>();
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### 1. è·å–ç”¨æˆ·èœå•

```bash
# å…ˆç™»å½•è·å– Token
TOKEN="eyJhbGc..."

# è¯·æ±‚èœå•
curl -X GET https://localhost:5001/api/menu/user-menus \
  -H "Authorization: Bearer $TOKEN"
```

### 2. éªŒè¯è¶…çº§ç®¡ç†å‘˜

ä½¿ç”¨ `admin` ç™»å½•ï¼Œåº”è¯¥çœ‹åˆ°æ‰€æœ‰èœå•ã€‚

### 3. éªŒè¯æ™®é€šç”¨æˆ·

æ³¨å†Œæ–°ç”¨æˆ·ç™»å½•ï¼Œåº”è¯¥åªçœ‹åˆ°åˆ†é…ç»™"æ™®é€šç”¨æˆ·"è§’è‰²çš„èœå•ã€‚

---

## ğŸ“ ä»Šæ—¥æ€»ç»“

### âœ… å®Œæˆæ£€æŸ¥æ¸…å•

- [ ] å®ç°äº†èœå•æŸ¥è¯¢æœåŠ¡
- [ ] å®ç°äº†æ ‘å½¢ç»“æ„æ„å»º
- [ ] åŒºåˆ†äº†è¶…çº§ç®¡ç†å‘˜å’Œæ™®é€šç”¨æˆ·
- [ ] æµ‹è¯•äº†æƒé™éªŒè¯

---

[â¬…ï¸ ä¸Šä¸€å¤©](./04-Day04-è®¤è¯ä¸JWT.md) | [è¿”å›ç›®å½•](./README.md) | [ä¸‹ä¸€å¤© â¡ï¸](./06-Day06-Blazorè®¤è¯.md)

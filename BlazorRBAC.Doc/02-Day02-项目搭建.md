# Day 02 - é¡¹ç›®æ­å»ºä¸ FreeSql é…ç½®

> â±ï¸ é¢„è®¡æ—¶é—´ï¼š2å°æ—¶

## ğŸ¯ ä»Šæ—¥ç›®æ ‡

- [ ] åˆ›å»º .NET å¤šå±‚æ¶æ„è§£å†³æ–¹æ¡ˆ
- [ ] å®‰è£…æ ¸å¿ƒ NuGet åŒ…
- [ ] é…ç½® FreeSql å¹¶æµ‹è¯•è¿æ¥
- [ ] é…ç½® Serilog æ—¥å¿—

---

## ğŸ’» åˆ›å»ºè§£å†³æ–¹æ¡ˆ

### 1. é¡¹ç›®ç»“æ„

```
BlazorRBAC/
â”œâ”€â”€ BlazorRBAC.sln
â””â”€â”€ src/
    â”œâ”€â”€ BlazorRBAC.Domain/          # é¢†åŸŸå±‚ï¼ˆå®ä½“ï¼‰
    â”œâ”€â”€ BlazorRBAC.Application/     # åº”ç”¨å±‚ï¼ˆæœåŠ¡ï¼‰
    â”œâ”€â”€ BlazorRBAC.Infrastructure/  # åŸºç¡€è®¾æ–½ï¼ˆORMã€JWTï¼‰
    â”œâ”€â”€ BlazorRBAC.Api/             # WebAPI
    â””â”€â”€ BlazorRBAC.Web/             # Blazor Server
```

### 2. åˆ›å»ºå‘½ä»¤

```bash
# åˆ›å»ºè§£å†³æ–¹æ¡ˆ
dotnet new sln -n BlazorRBAC

# åˆ›å»ºå„å±‚é¡¹ç›®
dotnet new classlib -n BlazorRBAC.Domain -o src/BlazorRBAC.Domain
dotnet new classlib -n BlazorRBAC.Application -o src/BlazorRBAC.Application
dotnet new classlib -n BlazorRBAC.Infrastructure -o src/BlazorRBAC.Infrastructure
dotnet new webapi -n BlazorRBAC.Api -o src/BlazorRBAC.Api
dotnet new blazorserver -n BlazorRBAC.Web -o src/BlazorRBAC.Web

# æ·»åŠ åˆ°è§£å†³æ–¹æ¡ˆ
dotnet sln add src/BlazorRBAC.Domain/BlazorRBAC.Domain.csproj
dotnet sln add src/BlazorRBAC.Application/BlazorRBAC.Application.csproj
dotnet sln add src/BlazorRBAC.Infrastructure/BlazorRBAC.Infrastructure.csproj
dotnet sln add src/BlazorRBAC.Api/BlazorRBAC.Api.csproj
dotnet sln add src/BlazorRBAC.Web/BlazorRBAC.Web.csproj

# é¡¹ç›®å¼•ç”¨å…³ç³»
dotnet add src/BlazorRBAC.Application reference src/BlazorRBAC.Domain
dotnet add src/BlazorRBAC.Infrastructure reference src/BlazorRBAC.Domain
dotnet add src/BlazorRBAC.Api reference src/BlazorRBAC.Application src/BlazorRBAC.Infrastructure
dotnet add src/BlazorRBAC.Web reference src/BlazorRBAC.Application src/BlazorRBAC.Infrastructure
```

---

## ğŸ“¦ å®‰è£… NuGet åŒ…

### Infrastructure å±‚ï¼ˆæ•°æ®è®¿é—®ï¼‰

```bash
cd src/BlazorRBAC.Infrastructure

# FreeSql ORM
dotnet add package FreeSql
dotnet add package FreeSql.Provider.PostgreSQL

# è®¤è¯ç›¸å…³
dotnet add package BCrypt.Net-Next
dotnet add package System.IdentityModel.Tokens.Jwt

# æ—¥å¿—
dotnet add package Serilog.AspNetCore
dotnet add package Serilog.Sinks.Console
dotnet add package Serilog.Sinks.File
```

### Application å±‚ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰

```bash
cd ../BlazorRBAC.Application

# éªŒè¯ä¸æ˜ å°„
dotnet add package FluentValidation
dotnet add package FluentValidation.AspNetCore
dotnet add package Mapster
```

### Api å±‚ï¼ˆWebAPIï¼‰

```bash
cd ../BlazorRBAC.Api

# JWTè®¤è¯
dotnet add package Microsoft.AspNetCore.Authentication.JwtBearer

# APIæ–‡æ¡£
dotnet add package Scalar.AspNetCore

# å…¶ä»–
dotnet add package Spectre.Console
```

### Web å±‚ï¼ˆBlazorï¼‰

```bash
cd ../BlazorRBAC.Web

# MudBlazor UI
dotnet add package MudBlazor
```

---

## ğŸ”§ é…ç½® FreeSql

### 1. Infrastructure å±‚åˆ›å»ºé…ç½®ç±»

**æ–‡ä»¶**ï¼š`src/BlazorRBAC.Infrastructure/FreeSql/FreeSqlSetup.cs`

```csharp
using FreeSql;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.DependencyInjection;

namespace BlazorRBAC.Infrastructure.FreeSql;

public static class FreeSqlSetup
{
    public static IServiceCollection AddFreeSqlSetup(
        this IServiceCollection services, 
        IConfiguration configuration)
    {
        // è·å–è¿æ¥å­—ç¬¦ä¸²
        var connectionString = configuration.GetConnectionString("Default")
            ?? throw new Exception("æœªé…ç½®æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²");

        // åˆ›å»º FreeSql å®ä¾‹
        var freeSql = new FreeSqlBuilder()
            .UseConnectionString(DataType.PostgreSQL, connectionString)
            .UseAutoSyncStructure(true)  // è‡ªåŠ¨åŒæ­¥å®ä½“ç»“æ„åˆ°æ•°æ®åº“
            .Build();

        // æ³¨å†Œä¸ºå•ä¾‹
        services.AddSingleton<IFreeSql>(freeSql);

        return services;
    }
}
```

### 2. Api å±‚é…ç½®è¿æ¥å­—ç¬¦ä¸²

**æ–‡ä»¶**ï¼š`src/BlazorRBAC.Api/appsettings.json`

```json
{
  "ConnectionStrings": {
    "Default": "Host=localhost;Port=5432;Database=blazor_rbac;Username=postgres;Password=postgres123"
  },
  "Logging": {
    "LogLevel": {
      "Default": "Information"
    }
  }
}
```

### 3. Api å±‚æ³¨å†ŒæœåŠ¡

**æ–‡ä»¶**ï¼š`src/BlazorRBAC.Api/Program.cs`

```csharp
using BlazorRBAC.Infrastructure.FreeSql;

var builder = WebApplication.CreateBuilder(args);

// æ·»åŠ  FreeSql
builder.Services.AddFreeSqlSetup(builder.Configuration);

// å…¶ä»–æœåŠ¡...
builder.Services.AddControllers();
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen();

var app = builder.Build();

// é…ç½®HTTPç®¡é“...
if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();
}

app.UseHttpsRedirection();
app.UseAuthorization();
app.MapControllers();

app.Run();
```

---

## ğŸ§ª æµ‹è¯•è¿æ¥

### åˆ›å»ºæµ‹è¯•æ§åˆ¶å™¨

**æ–‡ä»¶**ï¼š`src/BlazorRBAC.Api/Controllers/TestController.cs`

```csharp
using Microsoft.AspNetCore.Mvc;

namespace BlazorRBAC.Api.Controllers;

[ApiController]
[Route("api/[controller]")]
public class TestController : ControllerBase
{
    private readonly IFreeSql _fsql;

    public TestController(IFreeSql fsql)
    {
        _fsql = fsql;
    }

    [HttpGet("db-connection")]
    public IActionResult TestConnection()
    {
        try
        {
            // æµ‹è¯•æŸ¥è¯¢
            var result = _fsql.Ado.ExecuteScalar("SELECT version()");
            
            return Ok(new
            {
                success = true,
                message = "æ•°æ®åº“è¿æ¥æˆåŠŸï¼",
                version = result?.ToString()
            });
        }
        catch (Exception ex)
        {
            return StatusCode(500, new
            {
                success = false,
                message = "æ•°æ®åº“è¿æ¥å¤±è´¥",
                error = ex.Message
            });
        }
    }
}
```

### è¿è¡Œæµ‹è¯•

```bash
cd src/BlazorRBAC.Api
dotnet run

# è®¿é—®ï¼šhttps://localhost:5001/api/test/db-connection
# åº”è¯¥è¿”å›æ•°æ®åº“ç‰ˆæœ¬ä¿¡æ¯
```

---

## ğŸ“ é…ç½® Serilogï¼ˆå¯é€‰ä½†æ¨èï¼‰

**æ–‡ä»¶**ï¼š`src/BlazorRBAC.Api/Program.cs`

```csharp
using Serilog;

// é…ç½® Serilog
Log.Logger = new LoggerConfiguration()
    .MinimumLevel.Information()
    .WriteTo.Console()
    .WriteTo.File("logs/app-.txt", rollingInterval: RollingInterval.Day)
    .CreateLogger();

var builder = WebApplication.CreateBuilder(args);

// ä½¿ç”¨ Serilog
builder.Host.UseSerilog();

// ... å…¶ä»–é…ç½® ...

try
{
    Log.Information("åº”ç”¨ç¨‹åºå¯åŠ¨");
    app.Run();
}
catch (Exception ex)
{
    Log.Fatal(ex, "åº”ç”¨ç¨‹åºå¯åŠ¨å¤±è´¥");
}
finally
{
    Log.CloseAndFlush();
}
```

---

## ğŸ“‹ ä»Šæ—¥æ€»ç»“

### âœ… å®Œæˆæ£€æŸ¥æ¸…å•

- [ ] åˆ›å»ºäº†5å±‚æ¶æ„çš„è§£å†³æ–¹æ¡ˆ
- [ ] å®‰è£…äº†æ‰€æœ‰å¿…éœ€çš„ NuGet åŒ…
- [ ] é…ç½®äº† FreeSql å¹¶æˆåŠŸè¿æ¥æ•°æ®åº“
- [ ] æµ‹è¯•äº†æ•°æ®åº“è¿æ¥
- [ ] é…ç½®äº† Serilog æ—¥å¿—ï¼ˆå¯é€‰ï¼‰

### ğŸ“ çŸ¥è¯†ç‚¹

1. **å¤šå±‚æ¶æ„**ï¼šåˆ†ç¦»å…³æ³¨ç‚¹ï¼Œä¾¿äºç»´æŠ¤
2. **FreeSql**ï¼šè½»é‡çº§ ORMï¼Œæ”¯æŒå¤šæ•°æ®åº“
3. **ä¾èµ–æ³¨å…¥**ï¼šé€šè¿‡ IFreeSql æ¥å£æ³¨å…¥

---

## â¡ï¸ ä¸‹ä¸€æ­¥

æ˜å¤©ï¼ˆDay 3ï¼‰æˆ‘ä»¬å°†ï¼š
- å®šä¹‰ 5 ä¸ªå®ä½“ç±»
- ä½¿ç”¨ CodeFirst è‡ªåŠ¨ç”Ÿæˆè¡¨
- ç¼–å†™ç§å­æ•°æ®æœåŠ¡

---

[â¬…ï¸ ä¸Šä¸€å¤©](./01-Day01-ç¯å¢ƒä¸æ•°æ®åº“.md) | [è¿”å›ç›®å½•](./README.md) | [ä¸‹ä¸€å¤© â¡ï¸](./03-Day03-å®ä½“ä¸åˆå§‹åŒ–.md)

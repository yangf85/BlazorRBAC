@page "/"
@using Microsoft.AspNetCore.Components.Authorization
@using BlazorRBAC.Web.Services
@inject AuthenticationStateProvider AuthStateProvider
@inject CustomAuthenticationStateProvider CustomAuthStateProvider
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

@if (_isChecking)
{
    <MudContainer Class="d-flex justify-center align-center" Style="height: 100vh;">
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    </MudContainer>
}
else if (_isAuthenticated)
{
    <PageTitle>首页</PageTitle>

    <MudContainer MaxWidth="MaxWidth.Large" Class="mt-8">
        <!-- ✅ 修改：添加 flex 布局和退出按钮 -->
        <div class="d-flex justify-space-between align-center mb-4">
            <MudText Typo="Typo.h3">
                欢迎回来，@_userName
            </MudText>
            
            <MudButton Variant="Variant.Outlined" 
                      Color="Color.Error" 
                      StartIcon="@Icons.Material.Filled.Logout"
                      OnClick="HandleLogoutAsync">
                退出登录
            </MudButton>
        </div>

        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.h6">系统信息</MudText>
            <MudDivider Class="my-2" />
            <MudText>用户ID: @_userId</MudText>
            <MudText>角色: @string.Join(", ", _roles)</MudText>
        </MudPaper>
    </MudContainer>
}

@code {

    private bool _isChecking = true;
    private bool _isAuthenticated = false;
    private string _userName = string.Empty;
    private string _userId = string.Empty;
    private List<string> _roles = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // 获取认证状态
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            _isAuthenticated = user.Identity?.IsAuthenticated ?? false;

            if (!_isAuthenticated)
            {
                // 未登录 → 跳转登录页
                Navigation.NavigateTo("/login", true);
                return;
            }

            // 已登录 → 提取用户信息
            _userName = user.Identity?.Name ?? "未知用户";
            _userId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? "";
            _roles = user.FindAll(System.Security.Claims.ClaimTypes.Role)
                .Select(c => c.Value)
                .ToList();
        }
        catch (Exception)
        {
            // 出错 → 跳转登录页
            Navigation.NavigateTo("/login", true);
        }
        finally
        {
            _isChecking = false;
        }
    }

    /// <summary>
    /// ✅ 新增：处理退出登录
    /// </summary>
    private async Task HandleLogoutAsync()
    {
        try
        {
            // 清除认证状态和 Token
            await CustomAuthStateProvider.MarkUserAsLoggedOutAsync();

            // 显示提示
            Snackbar.Add("已退出登录", Severity.Info);

            // 跳转到登录页
            Navigation.NavigateTo("/login", true);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"退出失败：{ex.Message}", Severity.Error);
        }
    }
}
